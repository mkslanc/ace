<!DOCTYPE html>
<html lang="en">
<head>
    <title>Ace-diff - Simple Demo #1</title>

    <script src="../demo/kitchen-sink/require.js"></script>

    <style type="text/css">
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }

        .ace_diff-container {
            height: 100vh;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #f1f1f1;
            border-bottom: 1px solid #ddd;
        }

        .toolbar button {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }

        .toolbar button:hover {
            background: #e6e6e6;
        }

    </style>
</head>
<body>

<div class="toolbar">
    <button id="btn-prev" onclick="goToPrevious()">Previous</button>
    <button id="btn-next" onclick="goToNext()">Next</button>
    <button id="" onclick="setMode('inlineA')">inlineA</button>
    <button id="" onclick="setMode('inlineB')">inlineB</button>
    <button id="" onclick="setMode('split')">split</button>
    <button id="" onclick="setMode('off')">off</button>
    <!--  <button id="btn-use-old">Use Old</button>
      <button id="btn-use-new">Use New</button>
      <button id="btn-use-both">Use Both</button>-->
    <label>
        <input type="checkbox" id="btn-whitespace" checked onclick="trimWhitespace()"> Ignore Trim Whitespaces
    </label>
    <label>
        <input type="checkbox" id="btn-syncselections" onclick="syncSelections()"> Sync selections
    </label>
    <label>
    <input type="checkbox" id="btn-foldunchanged" onclick="foldUnchanged()"> Collapse unchanged lines
    </label>

    <button id="btn-reset" onclick="reset()">Reset</button>
</div>

<div class="ace_diff-container"></div>

<script>
    var ignoreTrimWhitespace = localStorage["ignoreTrimWhitespace"] == "true";
    var foldUnchanged = localStorage["foldunchanged"] == "true";

    var initialValueA = "";
    var initialValueB = "";

    var diffView = null;
    var editorA = null;
    var editorB = null;
    var updateButtonsState = () => {
        if (!diffView) return;
        document.getElementById("btn-prev").disabled = diffView.firstDiffSelected();
        document.getElementById("btn-next").disabled = diffView.lastDiffSelected();
    };

    var goToNext = () => {
        diffView.gotoNext(1);
        updateButtonsState();
    };

    var goToPrevious = () => {
        diffView.gotoNext(-1);
        updateButtonsState();
    };

    var trimWhitespace = () => {
        var checked = document.getElementById("btn-whitespace").checked;
        diffView.options.ignoreTrimWhitespace = checked;
        diffView.onInput();
        localStorage.setItem("ignoreTrimWhitespace", ignoreTrimWhitespace);
    };

    var syncSelections = () => {
        var checked = document.getElementById("btn-syncselections").checked;
        diffView.options.syncSelections = checked;
        diffView.onInput();
    };

    var foldUnchanged = () => {
        var checked = document.getElementById("btn-foldunchanged").checked;
        diffView.options.foldUnchanged = checked;
        diffView.onInput();
        if (!checked) {
            diffView.diffSession.sessionA.unfold();
            diffView.diffSession.sessionB.unfold();
        }
        localStorage.setItem("foldunchanged", checked);
    };

    function reset() {
        editorA.setValue(initialValueA, -1);
        editorB.setValue(initialValueB, -1);
        
        localStorage.removeItem("valueA");
        localStorage.removeItem("valueB");
    }

    var diffViewMode = "off";
    var diffVewContainer = document.querySelector(".ace_diff-container");
    var setMode = (mode) => {
        if (diffViewMode == mode) return;

        localStorage.diffViewMode = diffViewMode = mode;

        if (diffView) {
            diffView.detach();
        }
        switch (mode) {
            case "inlineA":
                
                var {InlineDiffView} = require("diff/inline_diff_view");
                diffView = new InlineDiffView({
                    editorA, editorB,
                    showSideA: true
                });
                // editorA.container.style.display = "none";
                break;
            case "inlineB":
                var {InlineDiffView} = require("diff/inline_diff_view");
                diffView = new InlineDiffView({
                    editorA, editorB,
                    showSideA: false
                });
                // editorA.container.style.display = "none";
                break;
            case "split":
                var {SideBySideDiffView} = require("diff/sidebyside_diff_view");
                diffView = new SideBySideDiffView({editorA, editorB});
                // editorA.container.style.display = "";
                break;
            case "off":
                diffView.detach("off");
                diffView = undefined;
                // editorA.container.style.display = "";
                break;
        }
        diffView.onInput();
    }

    var paths = {
        "ace": "../src",
        "ace-code": "..",
        diff: ".",
        demo: "../demo",
    };

    require.config({
        paths: paths
    });


    require(["diff/sidebyside_diff_view", "diff/inline_diff_view", "demo/kitchen-sink/util"], function () {

        var config = require("ace/config");
        config.setLoader(function (moduleName, cb) {
            require([moduleName], function (module) {
                cb(null, module);
            });
        });

        var util = require("demo/kitchen-sink/util");
        splitEditor = util.createSplitEditor(diffVewContainer);

        editorA = splitEditor.editor0;
        editorB = splitEditor.editor1; 

        require("ace/lib/net").get("./diff/0.ts", function (v) {
            initialValueA = v;
            editorA.setValue(localStorage.valueA || v, -1);
            editorA.session.setMode("ace/mode/typescript");
        });
        require("ace/lib/net").get("./diff/1.ts", function (v) {
            initialValueB = v;
            editorB.setValue(localStorage.valueB || v, -1);
            editorB.session.setMode("ace/mode/typescript");
        });

        window.onbeforeunload = function () {
            localStorage.valueA = editorA.getValue();
            localStorage.valueB = editorB.getValue();
        };

        editorA.on("changeSelection", updateButtonsState);
        editorB.on("changeSelection", updateButtonsState);

        setMode(localStorage.diffViewMode || "split");
    });

</script>


</body>
</html>
